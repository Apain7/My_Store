{% load static %}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…ØªØ¬Ø± Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª | Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />

    <style>
      /* --- Ø¹Ø§Ù… --- */
      :root {
        --primary: #007bff;
        --accent: #005a82;
        --warning: #ffc107;
        --success: #28a745;
        --danger: #dc3545;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #f1f3f5;
        color: #222;
      }

      /* --- Navbar --- */
      .navbar {
        display: flex;
        gap: 12px;
        align-items: center;
        background-color: var(--primary);
        padding: 10px 16px;
        color: white;
      }
      .logo a {
        font-weight: bold;
        font-size: 22px;
        color: white;
        text-decoration: none;
      }
      .nav-links {
        margin-right: auto;
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .nav-links a {
        color: white;
        text-decoration: none;
      }
      .user-area {
        margin-left: 12px;
        color: white;
      }

      /* --- Category filter (center) --- */
      .category-nav {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-grow: 1;
      }
      .category-nav .btn {
        padding: 6px 12px;
        background: var(--accent);
        color: white;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
      }
      .category-nav .btn.active {
        background-color: var(--warning) !important;
        color: #333 !important;
      }

      /* --- Layout --- */
      .main-content {
        display: flex;
        gap: 20px;
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 16px;
        align-items: flex-start;
      }
      .sidebar {
        width: 280px;
        padding: 18px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        height: fit-content;
      }
      .product-list-section {
        flex-grow: 1;
      }

      /* --- Product grid --- */
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
      }
      .product-card {
        background: white;
        border: 1px solid #e3e6ea;
        border-radius: 10px;
        padding: 12px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        position: relative;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      .product-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      }
      .product-card img {
        width: 90%;
        height: 170px;
        object-fit: contain;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      h2.section-title {
        margin: 0 0 14px;
        color: #333;
      }

      .price {
        color: var(--danger);
        font-weight: bold;
        font-size: 18px;
        display: block;
        margin: 6px 0;
      }

      .btn-inline {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 6px;
        text-decoration: none;
        cursor: pointer;
        border: none;
        font-size: 14px;
      }

      .btn-detail {
        background: var(--primary);
        color: #fff;
        margin-right: 8px;
      }
      .btn-add {
        background: var(--warning);
        color: #333;
      }

      /* --- specs table --- */
      .specs-table {
        display: none;
        width: 100%;
        margin-top: 10px;
        border-collapse: collapse;
      }
      .specs-table th,
      .specs-table td {
        padding: 8px;
        border: 1px solid #eee;
        text-align: right;
        font-size: 13px;
      }
      .specs-table th {
        background: #f8f9fa;
        width: 40%;
      }

      /* --- Mini cart --- */
      .cart-icon-container {
        position: relative;
        margin-left: 10px;
      }
      .cart-icon {
        font-size: 22px;
        cursor: pointer;
        color: white;
        padding: 6px 10px;
        background: var(--success);
        border-radius: 6px;
        display: inline-block;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--danger);
        color: #fff;
        border-radius: 50%;
        padding: 2px 7px;
        font-size: 12px;
        font-weight: bold;
      }
      .mini-cart {
        position: absolute;
        top: 54px;
        left: 0;
        width: 340px;
        background: white;
        border: 1px solid #e6e6e6;
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
        border-radius: 8px;
        z-index: 1200;
        padding: 12px;
        display: none;
        text-align: right;
      }
      .mini-cart.active {
        display: block;
      }
      .cart-items {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 260px;
        overflow: auto;
      }
      .cart-item {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px dotted #eee;
      }
      .cart-item img {
        width: 54px;
        height: 54px;
        object-fit: cover;
        border-radius: 6px;
        margin-left: 6px;
      }
      .cart-item-info {
        flex: 1;
        text-align: right;
        font-size: 13px;
      }
      .cart-item-controls {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .small-btn {
        padding: 4px 7px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-size: 13px;
      }

      .cart-total {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 2px solid #eee;
        font-weight: bold;
        font-size: 15px;
        text-align: left;
      }

      /* --- Footer --- */
      footer.footer {
        text-align: center;
        padding: 18px;
        background: #343a40;
        color: white;
        margin-top: 30px;
      }

      /* --- Responsive tweaks --- */
      @media (max-width: 900px) {
        .main-content {
          flex-direction: column;
          padding: 0 12px;
        }
        .sidebar {
          width: 100%;
          order: 2;
        }
        .category-nav {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- NAVBAR -->
    <header class="navbar">
      <div class="logo"><a href="{% url 'home' %}">Ù…ØªØ¬Ø± Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</a></div>

      <!-- Category filter (ÙˆØ³Ø·) -->
      <div class="category-nav" role="navigation" aria-label="ÙÙ„ØªØ±Ø© Ø§Ù„ÙØ¦Ø§Øª">
        <a
          href="{% url 'home' %}?category=Laptop"
          class="btn {% if selected_category == 'Laptop' %}active{% endif %}"
          >Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª</a
        >
        <a
          href="{% url 'home' %}?category=Mobile"
          class="btn {% if selected_category == 'Mobile' %}active{% endif %}"
          >Ù…ÙˆØ¨Ø§ÙŠÙ„</a
        >
        <a
          href="{% url 'home' %}?category=Accessories"
          class="btn {% if selected_category == 'Accessories' %}active{% endif %}"
          >Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</a
        >
        <a
          href="{% url 'home' %}"
          class="btn {% if selected_category == 'All' or not selected_category %}active{% endif %}"
          >Ø§Ù„ÙƒÙ„</a
        >
      </div>

      <!-- Cart icon -->
      <div class="cart-icon-container" style="margin-left: 12px">
        <div
          class="cart-icon"
          onclick="toggleCart()"
          aria-haspopup="true"
          aria-expanded="false"
        >
          ğŸ›’
          <span id="cart-item-count" class="cart-count">0</span>
        </div>

        <div
          id="mini-cart"
          class="mini-cart"
          aria-label="Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØµØºØ±Ø©"
          role="dialog"
        >
          <h4 style="margin: 0 0 8px 0; text-align: right">Ø§Ù„Ø³Ù„Ø©</h4>
          <ul id="cart-items-list" class="cart-items"></ul>
          <div class="cart-total" id="cart-total-display">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00$</div>
          <!-- Ø²Ø± ÙØªØ­ Ø§Ù„ÙÙˆØ±Ù… -->
          <button
            id="checkout-open-btn"
            style="
              display: block;
              width: 100%;
              margin-top: 10px;
              padding: 8px;
              background: var(--success);
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            "
          >
            Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
          </button>
        </div>
      </div>

      <!-- Right nav links -->
      <nav class="nav-links" aria-label="Ø±ÙˆØ§Ø¨Ø·">
        <a href="{% url 'home' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="{% url 'about' %}">Ø¹Ù† Ø§Ù„Ù…ØªØ¬Ø±</a>
      </nav>

      <!-- User area -->
      <nav class="nav-links">
        {% if user.is_authenticated %}
        <span>{{ user.first_name }}</span>
        <a
          href="{% url 'logout_user' %}"
          style="color: white; margin-right: 8px"
          >ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
        >
        {% else %}
        <a href="{% url 'login' %}" style="color: white; margin-right: 8px"
          >ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a
        >
        {% endif %}
      </nav>
    </header>

    <!-- MAIN -->
    <div class="main-content">
      <!-- SIDEBAR -->
      <aside class="sidebar" aria-labelledby="about-shop">
        <h3 id="about-shop">Ø­ÙˆÙ„ Ù…ØªØ¬Ø± Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</h3>
        <p>
          Ù†Ø­Ù† Ù…ØªØ¬Ø±Ùƒ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨ ÙˆØ§Ù„Ù‡ÙˆØ§ØªÙ
          ÙˆØ§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª.
        </p>

        <h3 style="margin-top: 18px">Ù„Ù…Ø§Ø°Ø§ ØªØ´ØªØ±ÙŠ Ù…Ù† Ø¹Ù†Ø¯Ù†Ø§ØŸ ğŸ¥‡</h3>
        <ul>
          <li>Ø¶Ù…Ø§Ù† Ù„Ù…Ø¯Ø© Ø³Ù†ØªÙŠÙ† Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.</li>
          <li>Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ© ÙˆØ¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ©.</li>
          <li>Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ¯Ø¹Ù… ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©.</li>
          <li>Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ø±ÙŠØ¹.</li>
        </ul>
      </aside>

      <!-- PRODUCTS -->
      <section class="product-list-section" aria-labelledby="products-title">
        <h2 style="margin-bottom:20px;color:#333;">
            Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© ({{ product_list|length }} Ù…Ù†ØªØ¬Ø§Øª)
        </h2>

        <div class="product-grid">
          {% with items=product_list%} {% for x in items %}
          <div class="product-card" data-name="{{ x.name|escapejs }}">
            <img src="{{ x.image.url }}" alt="{{ x.name }}" />
            <h3 style="margin: 6px 0 4px">{{ x.name }}</h3>
            <p style="min-height: 36px; color: #6c757d">{{ x.content }}</p>
            <span class="price">{{ x.price }}$</span>

            <table class="specs-table" aria-hidden="true">
              <tbody>
                <tr>
                  <th>Ø§Ù„ÙØ¦Ø©</th>
                  <td>{{ x.category|default:"-" }}</td>
                </tr>
                <tr>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <td>{{ x.content|default:"-" }}</td>
                </tr>
                <tr>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <td>{{ x.price }}$</td>
                </tr>
                {% if x.specs %} {% for k,v in x.specs.items %}
                <tr>
                  <th>{{ k }}</th>
                  <td>{{ v }}</td>
                </tr>
                {% endfor %} {% endif %}
              </tbody>
            </table>

            <div
              style="
                margin-top: 10px;
                display: flex;
                justify-content: center;
                gap: 8px;
              "
            >
              <button
                class="btn-inline btn-detail"
                onclick="toggleDetails(this)"
                aria-expanded="false"
              >
                Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
              </button>

              <a
                href="#"
                class="btn-inline btn-add"
                onclick="addToCart(event, '{{ x.name|escapejs }}', '{{ x.price }}', '{{ x.image.url }}')"
                >Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</a
              >
            </div>
          </div>
          {% endfor %} {% endwith %}
        </div>
      </section>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
      <p>&copy; 2024 Ù…ØªØ¬Ø± Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    </footer>

    <!-- ==== Ø³ÙƒØ±Ø¨Øª ÙˆØ§Ø­Ø¯ ÙˆÙ…Ù†Ø¸Ù… Ù„Ù„Ø³Ù„Ø© Ùˆ checkout Ùˆ toggle details ==== -->
    <script>
      // ====== Ù…ØªØºÙŠØ± Ø§Ù„Ø³Ù„Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·) ======
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      // Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø©
      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆÙƒÙŠ (CSRFTOKEN)
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      const csrftoken = getCookie("csrftoken");

      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØµØºØ±Ø©
      function updateCartDisplay() {
        const list = document.getElementById("cart-items-list");
        const countDisplay = document.getElementById("cart-item-count");
        const totalDisplay = document.getElementById("cart-total-display");
        list.innerHTML = "";

        if (!cart || cart.length === 0) {
          list.innerHTML =
            '<li class="empty-cart-message">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</li>';
          countDisplay.textContent = 0;
          totalDisplay.textContent = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00$";
          return;
        }

        let total = 0;
        cart.forEach((item, idx) => {
          const li = document.createElement("li");
          li.className = "cart-item";

          li.innerHTML = `
                    <img src="${item.img}" alt="${item.name}">
                    <div class="cart-item-info">
                        <strong>${item.name}</strong>
                        <div style="margin-top:6px; font-size:13px; color:#6c757d;">
                            ${item.price.toFixed(2)}$ Ã— <span class="qty">${
            item.quantity
          }</span>
                        </div>
                        <div style="margin-top:6px;">
                            <button class="small-btn" onclick="changeQty(${idx}, -1)" title="Ù†Ù‚Øµ">-</button>
                            <button class="small-btn" onclick="changeQty(${idx}, 1)" title="Ø²ÙŠØ§Ø¯Ø©">+</button>
                        </div>
                    </div>
                    <div class="cart-item-controls" style="margin-left:8px;">
                        <button class="small-btn" style="background:#dc3545; color:white;" onclick="removeFromCart(${idx})">Ø­Ø°Ù</button>
                    </div>
                `;

          list.appendChild(li);
          total += item.price * item.quantity;
        });

        countDisplay.textContent = cart.reduce((s, i) => s + i.quantity, 0);
        totalDisplay.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)}$`;
      }

      // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© (ÙŠØ²ÙŠØ¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯)
      function addToCart(event, name, price, img) {
        event && event.preventDefault();

        price = parseFloat(price) || 0;
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø±
        const existing = cart.find((i) => i.name === name && i.price === price);
        if (existing) {
          existing.quantity = (existing.quantity || 1) + 1;
        } else {
          cart.push({ name, price, img, quantity: 1 });
        }
        saveCart();
        updateCartDisplay();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙŠÙ†ÙŠ ÙƒØ§Ø±Øª Ù…Ø¤Ù‚ØªÙ‹Ø§
        const mini = document.getElementById("mini-cart");
        mini.classList.add("active");
        clearTimeout(mini.timer);
        mini.timer = setTimeout(() => mini.classList.remove("active"), 3000);
      }

      // ØªØºÙŠÙŠØ± ÙƒÙ…ÙŠØ©
      function changeQty(index, delta) {
        if (!cart[index]) return;
        cart[index].quantity = Math.max(1, (cart[index].quantity || 1) + delta);
        saveCart();
        updateCartDisplay();
      }

      // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©
      function removeFromCart(index) {
        if (index < 0 || index >= cart.length) return;
        cart.splice(index, 1);
        saveCart();
        updateCartDisplay();
      }

      // ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙŠÙ†ÙŠ ÙƒØ§Ø±Øª
      function toggleCart() {
        const mini = document.getElementById("mini-cart");
        mini.classList.toggle("active");
      }

      // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯ÙØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙŠÙ†ÙŠ ÙƒØ§Ø±Øª
      function openCheckoutForm() {
        const mini = document.getElementById("mini-cart");

        // Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ø© Ø£Ùˆ ÙØ§Ø±ØºØ©
        if (!cart || cart.length === 0) {
          alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
          return;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙˆØ±Ù… Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙ„Ø§ Ù†Ø¹ÙŠØ¯Ù‡
        if (document.getElementById("checkout-form")) return;

        const formHtml = `
                <div id="checkout-form" style="margin-top:10px; text-align:right;">
                    <h5 style="margin:0 0 8px;">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h5>
                    <input id="cust-name" placeholder="Ø§Ù„Ø§Ø³Ù…" style="width:100%; padding:8px; margin-bottom:6px;">
                    <input id="cust-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="width:100%; padding:8px; margin-bottom:6px;">
                    <input id="cust-phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" style="width:100%; padding:8px; margin-bottom:6px;">
                    <textarea id="cust-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" style="width:100%; padding:8px; margin-bottom:6px;"></textarea>


                    <button id="confirm-order-btn" style="width:100%; padding:10px; background:${
                      getComputedStyle(
                        document.documentElement
                      ).getPropertyValue("--primary") || "#007bff"
                    }; color:white; border:none; border-radius:6px; cursor:pointer;">
                        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
                    </button>

                    <div id="checkout-msg" style="margin-top:8px;"></div>
                </div>
            `;
        mini.insertAdjacentHTML("beforeend", formHtml);
        document
          .getElementById("confirm-order-btn")
          .addEventListener("click", doCheckout);
      }

      // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ endpoint
      async function doCheckout(e) {
        e && e.preventDefault();

        if (!cart || cart.length === 0) {
          alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
          return;
        }

        const name = document.getElementById("cust-name").value.trim();
        const email = document.getElementById("cust-email").value.trim();
        const phone = document.getElementById("cust-phone").value.trim();
        const address = document.getElementById("cust-address").value.trim();

        if (!name || !address) {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
          return;
        }

        const items = cart.map((i) => ({
          product_name: i.name,
          price: parseFloat(i.price),
          quantity: i.quantity || 1,
        }));

        const payload = {
          customer_name: name,
          customer_email: email,
          customer_phone: phone,
          customer_address: address,
          items: items,
        };

        try {
          const resp = await fetch("/api/checkout/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify(payload),
          });

          const checkoutMsgEl = document.getElementById("checkout-msg");

          if (resp.ok) {
            const data = await resp.json();
            checkoutMsgEl.innerHTML = `<div style="padding:8px; background:#d4edda; color:#155724; border-radius:6px;">
                            ${data.detail || "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨"}${
              data.order_id ? " â€” Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: " + data.order_id : ""
            }
                        </div>`;

            // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
            cart = [];
            saveCart();
            updateCartDisplay();

            // Ø§Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆØ±Ù… Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            setTimeout(() => {
              const formEl = document.getElementById("checkout-form");
              if (formEl) formEl.remove();
            }, 2000);
          } else {
            const err = await resp.json().catch(() => ({}));
            const msg = err.detail || JSON.stringify(err);
            checkoutMsgEl.innerHTML = `<div style="padding:8px; background:#f8d7da; color:#721c24; border-radius:6px;">
                            Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: ${msg}
                        </div>`;
          }
        } catch (error) {
          console.error(error);
          const checkoutMsgEl = document.getElementById("checkout-msg");
          if (checkoutMsgEl) {
            checkoutMsgEl.innerHTML = `<div style="padding:8px; background:#f8d7da; color:#721c24; border-radius:6px;">
                            Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….
                        </div>`;
          }
        }
      }

      // Toggle ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (button handler)
      function toggleDetails(button) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        const card = button.closest(".product-card");
        if (!card) return;
        const table = card.querySelector(".specs-table");
        if (!table) return;

        if (table.style.display === "" || table.style.display === "none") {
          table.style.display = "table";
          button.textContent = "Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„";
          button.style.backgroundColor = "#dc3545";
          button.setAttribute("aria-expanded", "true");
        } else {
          table.style.display = "none";
          button.textContent = "Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„";
          button.style.backgroundColor = "";
          button.setAttribute("aria-expanded", "false");
        }
      }

      // Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© (ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)
      document.addEventListener("DOMContentLoaded", function () {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        cart = JSON.parse(localStorage.getItem("cart")) || [];
        updateCartDisplay();

        // Ø±Ø¨Ø· Ø²Ø± ÙØªØ­ Ø§Ù„ÙÙˆØ±Ù…
        const openBtn = document.getElementById("checkout-open-btn");
        if (openBtn) openBtn.addEventListener("click", openCheckoutForm);

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙŠÙ†ÙŠ ÙƒØ§Ø±Øª Ø¥Ø°Ø§ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø®Ø§Ø±Ø¬Ù‡
        document.addEventListener("click", function (e) {
          const mini = document.getElementById("mini-cart");
          const icon = document.querySelector(".cart-icon");
          if (!mini || !icon) return;
          if (!mini.contains(e.target) && !icon.contains(e.target)) {
            mini.classList.remove("active");
          }
        });

        // ØªØ­Ø³ÙŠÙ†: Ø¯Ø¹Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ø¨Ø± Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
        document.querySelectorAll(".btn-detail").forEach((btn) => {
          btn.addEventListener("keydown", function (ev) {
            if (ev.key === "Enter" || ev.key === " ") {
              ev.preventDefault();
              toggleDetails(btn);
            }
          });
        });
      });
    </script>
  </body>
</html>
